# コントロールパネルのリファクタリング設計

## 背景と課題

エディタ画面のコントロールパネル（`+control-panel.tsx`）は現在約500行のコードを含み、複数の責務を持つコンポーネントとなっている。具体的には、スライド画像の読み込みと管理、AI生成処理の制御、コスト計算と表示、候補画像の選択といった処理が単一のコンポーネント内に混在している。

この構造により、useState と useEffect が大量に並び、コードの見通しが悪い。また、状態管理のロジックとUI表示が密結合しているため、テストが困難であり、将来的な機能追加や変更時の影響範囲が予測しづらい。

最近、スライド切り替え時に前のスライドの画像が表示されるバグや、画像読み込みの遅延問題が発生した。これらは状態管理の複雑さに起因するものであり、リファクタリングの必要性を示している。

## リファクタリングの目的

コードの可読性と保守性を向上させることが第一の目的である。具体的には、各責務を明確に分離し、それぞれが独立してテスト可能な単位とすることで、将来的なバグの発生を抑え、機能追加時の変更範囲を局所化する。

マーティン・ファウラーの提唱するリファクタリング原則に従い、小さなステップで段階的に改善を進める。各ステップでは既存の動作を保証しながら構造を改善し、TypeScriptの型システムを活用してリグレッションを防ぐ。

## 設計アプローチ

### 責務の分離

コントロールパネルの機能を以下の3つの独立した責務に分離する。

**画像管理** は、オリジナル画像と生成された候補画像の読み込み、キャッシュ、そしてスライド切り替え時のクリーンアップを担当する。Object URLのライフサイクル管理が重要であり、メモリリークを防ぐために適切なクリーンアップが必要である。

**生成処理制御** は、ユーザーが入力したプロンプトに基づくAI生成のトリガー、進行状況の追跡、エラーハンドリング、そして生成結果の保存を担当する。APIキーの検証、バリデーション、アナリティクスイベントの送信など、多くの副作用を伴う処理である。

**コスト計算** は、為替レートの取得、入力トークンと出力トークン数の推定、コスト表示のフォーマットを担当する。生成処理とは独立した純粋な計算処理である。

### 段階的な移行戦略

Phase 1では、既存のコンポーネント内で関数を抽出し、責務ごとにコードを整理する。この段階ではファイル構造は変更せず、あくまで同一ファイル内でのリファクタリングにとどめる。TypeScriptの型推論により、関数抽出時の誤りを早期に検出できる。

Phase 2では、整理された関数群をカスタムフックとして独立したファイルに移動する。`hooks/useSlideImages.ts`、`hooks/useSlideGeneration.ts`、`hooks/useCostEstimate.ts` の3つのファイルを作成し、それぞれに対応する責務を移譲する。各フックは明確なインターフェースを持ち、戻り値の型を明示することで、利用側での誤用を防ぐ。

Phase 3では、UIコンポーネントを分割する。プロンプト入力フォーム、候補画像グリッド、コスト表示といった視覚的なまとまりに基づいてコンポーネントを切り出す。この段階では、親コンポーネントはカスタムフックから受け取った状態と関数を子コンポーネントに渡すだけの薄い層となる。

### 各Phaseの検証方法

各Phaseの完了後は必ず動作確認を行う。スライドの切り替え、画像の生成、候補の選択といった主要な操作が正しく動作することを確認する。TypeScriptのコンパイルが通ることはもちろん、pnpm validateコマンドによるフォーマット、lint、型チェックをすべてパスすることを確認する。

## 期待される効果

リファクタリング後のコードは、各カスタムフックが50〜100行程度、親コンポーネントが100行程度となり、それぞれが単一の責務を持つ構造となる。これにより、新たな機能の追加や既存機能の変更時に、影響範囲が明確になる。

また、カスタムフックは単体でテスト可能となるため、将来的にテストコードを追加する際の基盤が整う。状態管理のロジックがUIから分離されることで、ロジックの変更がUIに影響を与えにくくなり、逆もまた然りである。

このリファクタリングは、将来的な機能拡張、例えばバッチ生成機能や生成履歴の表示機能といった追加に対して、より柔軟に対応できる構造を提供する。
